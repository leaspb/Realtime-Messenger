<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —Å –∞—É–¥–∏–æ–∑–≤–æ–Ω–∫–∞–º–∏ (mesh)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f2f5;
        }
        #login-form, #chat-container, #users-list {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #messages {
            height: 300px;
            overflow-y: auto;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
            padding: 10px;
        }
        .message {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 18px;
            background: #e3f2fd;
            max-width: 70%;
        }
        .own {
            background: #0084ff;
            color: white;
            margin-left: auto;
        }
        .system-message {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin: 8px 0;
            font-style: italic;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #0084ff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #0073e6;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .hidden {
            display: none;
        }
        #call-status {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .call-active {
            background: #4caf50;
            color: white;
        }
        .call-waiting {
            background: #ff9800;
            color: white;
        }
        #debug-info {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üìû –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —Å –∞—É–¥–∏–æ–∑–≤–æ–Ω–∫–∞–º–∏ (mesh)</h1>

    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
    <div id="login-form">
        <h3>–í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É</h3>
        <input type="text" id="token" placeholder="–¢–æ–∫–µ–Ω" value="secret123">
        <input type="text" id="room-id" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="room1">
        <input type="number" id="max-users" placeholder="–ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤" value="6" min="2" max="10">
        <button onclick="joinRoom()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="chat-container" class="hidden">
        <div id="messages"></div>

        <div style="display: flex;">
            <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1;">
            <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –∑–≤–æ–Ω–∫–∞ -->
        <div id="call-status" class="hidden"></div>

        <!-- –ö–Ω–æ–ø–∫–∏ –∑–≤–æ–Ω–∫–∞ -->
        <div style="margin-top: 10px; display: flex; gap: 10px;">
            <button onclick="startCall()" id="start-btn" style="flex:1;">üé§ –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            <button onclick="endCall()" id="end-btn" style="flex:1;" disabled>üî¥ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
    <div id="users-list" class="hidden">
        <h4>–£—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="user-count">0</span>/<span id="max-users-display">6</span>)</h4>
        <div id="users"></div>
    </div>

    <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ) -->
    <div id="debug-info" class="hidden"></div>

    <script>
        // ================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==================
        const SIGNAL_SERVER_URL = 'wss://signal-server-risp.onrender.com';
        const CLIENT_VERSION = 'v2_mesh';  // –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –æ—Ç —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π

        // ================== –°–û–°–¢–û–Ø–ù–ò–ï ==================
        let ws = null;
        let userId = null;
        let roomId = null;
        let maxUsers = 6;
        let users = [];
        let peerConnections = new Map();        // userId -> RTCPeerConnection
        let localStream = null;
        let callActive = false;
        let callSessionId = null;               // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ç–µ–∫—É—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞

        // DOM-—ç–ª–µ–º–µ–Ω—Ç—ã
        const loginForm = document.getElementById('login-form');
        const chatContainer = document.getElementById('chat-container');
        const usersList = document.getElementById('users-list');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const usersDiv = document.getElementById('users');
        const userCountSpan = document.getElementById('user-count');
        const maxUsersSpan = document.getElementById('max-users-display');
        const debugInfo = document.getElementById('debug-info');
        const startBtn = document.getElementById('start-btn');
        const endBtn = document.getElementById('end-btn');
        const callStatus = document.getElementById('call-status');

        // ================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==================
        function debug(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            let text = `[${timestamp}] ${message}`;
            if (data) {
                try { text += `\n${JSON.stringify(data, null, 2)}`; } catch (e) { text += `\n${String(data)}`; }
            }
            console.log(text);
            debugInfo.textContent += text + '\n';
            debugInfo.classList.remove('hidden');
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'system-message';
            div.textContent = text;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addMessage(text, senderId, isOwn = false) {
            const div = document.createElement('div');
            div.className = 'message' + (isOwn ? ' own' : '');
            const senderName = (senderId === userId) ? '–í—ã' : senderId.substring(0,6) + '...';
            div.innerHTML = `<strong>${senderName}:</strong> ${text}`;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateUsersList() {
            userCountSpan.textContent = users.length;
            maxUsersSpan.textContent = maxUsers;
            usersDiv.innerHTML = users.map(id => {
                const isMe = id === userId;
                return `<div>${isMe ? 'üë§ –í—ã' : 'üë• ' + id.substring(0,6) + '...'}</div>`;
            }).join('');
        }

        // –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ: –∫—Ç–æ —Å–æ–∑–¥–∞—ë—Ç offer (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)
        function shouldInitiateConnection(targetUserId) {
            return userId < targetUserId;
        }

        // ================== –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ö–û–ú–ù–ê–¢–ï ==================
        function joinRoom() {
            const token = document.getElementById('token').value;
            let baseRoom = document.getElementById('room-id').value;
            maxUsers = parseInt(document.getElementById('max-users').value) || 6;

            // –ò–∑–æ–ª—è—Ü–∏—è –≤–µ—Ä—Å–∏–π: –¥–æ–±–∞–≤–ª—è–µ–º —Å—É—Ñ—Ñ–∏–∫—Å –∫ –∫–æ–º–Ω–∞—Ç–µ, —á—Ç–æ–±—ã —Å—Ç–∞—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –Ω–µ –º–µ—à–∞–ª–∏—Å—å
            roomId = baseRoom + '_' + CLIENT_VERSION;

            debug('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ', { token, roomId, maxUsers });

            if (!token || !roomId) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            try {
                ws = new WebSocket(SIGNAL_SERVER_URL);

                ws.onopen = () => {
                    debug('‚úÖ WebSocket –æ—Ç–∫—Ä—ã—Ç');
                    ws.send(JSON.stringify({
                        type: 'join',
                        roomId: roomId,
                        token: token,
                        maxUsers: maxUsers,
                        version: CLIENT_VERSION
                    }));
                };

                ws.onmessage = async (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        debug('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ', data);

                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥—Ä—É–≥–æ–π –≤–µ—Ä—Å–∏–∏ (–µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –∏—Ö –ø—Ä–æ–ø—É—Å—Ç–∏–ª)
                        if (data.version && data.version !== CLIENT_VERSION) {
                            debug('–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–æ–π –≤–µ—Ä—Å–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞');
                            return;
                        }

                        switch (data.type) {
                            case 'joined':
                                handleJoined(data);
                                break;
                            case 'user_joined':
                                handleUserJoined(data);
                                break;
                            case 'user_left':
                                handleUserLeft(data);
                                break;
                            case 'info':
                                addSystemMessage(data.message);
                                break;
                            case 'error':
                                alert('–û—à–∏–±–∫–∞: ' + data.message);
                                break;
                            case 'message':
                                addMessage(data.text, data.senderId);
                                break;
                            case 'offer':
                                if (data.callSessionId !== callSessionId && callSessionId !== null) return;
                                await handleOffer(data);
                                break;
                            case 'answer':
                                if (data.callSessionId !== callSessionId) return;
                                await handleAnswer(data);
                                break;
                            case 'candidate':
                                if (data.callSessionId !== callSessionId) return;
                                await handleCandidate(data);
                                break;
                            default:
                                debug('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è', data.type);
                        }
                    } catch (e) {
                        debug('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è', e.message);
                    }
                };

                ws.onerror = (error) => {
                    debug('WebSocket –æ—à–∏–±–∫–∞', error);
                    alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–∏–≥–Ω–∞–ª—å–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.');
                };

                ws.onclose = () => {
                    debug('WebSocket –∑–∞–∫—Ä—ã—Ç');
                    resetUI();
                };

            } catch (error) {
                debug('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞', error.message);
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function handleJoined(data) {
            userId = data.userId;
            users = data.users || [];
            debug('–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ', { userId, users });

            loginForm.classList.add('hidden');
            chatContainer.classList.remove('hidden');
            usersList.classList.remove('hidden');

            updateUsersList();
            addSystemMessage('–í—ã –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ');
            addSystemMessage(`–í–∞—à ID: ${userId.substring(0,6)}...`);
        }

        function handleUserJoined(data) {
            debug('üë§ –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫', data);
            users.push(data.userId);
            updateUsersList();
            addSystemMessage(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${data.userId.substring(0,6)}... –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è`);

            // –ï—Å–ª–∏ –∑–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω, –∏–Ω–∏—Ü–∏–∏—Ä—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –Ω–æ–≤–∏—á–∫–æ–º (–µ—Å–ª–∏ –¥–æ–ª–∂–Ω—ã)
            if (callActive && localStream && shouldInitiateConnection(data.userId)) {
                setTimeout(() => {
                    if (callActive && users.includes(data.userId) && !peerConnections.has(data.userId)) {
                        createOffer(data.userId);
                    }
                }, 300);
            }
        }

        function handleUserLeft(data) {
            debug('üëã –£—á–∞—Å—Ç–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è', data);
            users = users.filter(id => id !== data.userId);
            updateUsersList();
            addSystemMessage(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${data.userId.substring(0,6)}... –æ—Ç–∫–ª—é—á–∏–ª—Å—è`);

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –Ω–∏–º
            if (peerConnections.has(data.userId)) {
                try { peerConnections.get(data.userId).close(); } catch (e) {}
                peerConnections.delete(data.userId);
                const audio = document.getElementById(`audio-${data.userId}`);
                if (audio) audio.remove();
            }

            // –ï—Å–ª–∏ –Ω–∏–∫–æ–≥–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –≤ –∑–≤–æ–Ω–∫–µ (–∫—Ä–æ–º–µ –Ω–∞—Å), –∑–∞–≤–µ—Ä—à–∞–µ–º
            if (callActive && users.filter(id => id !== userId).length === 0) {
                endCall();
            }
        }

        // ================== –ß–ê–¢ ==================
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            addMessage(text, userId, true);
            users.forEach(targetId => {
                if (targetId !== userId) {
                    ws.send(JSON.stringify({
                        type: 'message',
                        targetUserId: targetId,
                        text: text,
                        senderId: userId,
                        version: CLIENT_VERSION
                    }));
                }
            });

            messageInput.value = '';
        }

        // ================== –ó–í–û–ù–ö–ò (WEBRTC) ==================
        async function startCall() {
            try {
                debug('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                debug('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω');

                callActive = true;
                callSessionId = Date.now().toString() + '_' + Math.random().toString(36);

                startBtn.disabled = true;
                endBtn.disabled = false;
                callStatus.classList.remove('hidden');
                callStatus.textContent = 'üéµ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                callStatus.className = 'call-waiting';

                addSystemMessage('–ù–∞—á–∏–Ω–∞–µ–º –∞—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫...');

                const otherUsers = users.filter(id => id !== userId);
                if (otherUsers.length === 0) {
                    callStatus.textContent = '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤...';
                } else {
                    // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≥–¥–µ –º—ã –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä, —Å–æ–∑–¥–∞—ë–º offer
                    for (let i = 0; i < otherUsers.length; i++) {
                        const target = otherUsers[i];
                        if (shouldInitiateConnection(target)) {
                            setTimeout(() => {
                                if (callActive && users.includes(target)) {
                                    createOffer(target);
                                }
                            }, i * 200);
                        }
                    }
                }

            } catch (error) {
                debug('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', error.message);
                let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.\n';
                if (error.name === 'NotAllowedError') msg += '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                else if (error.name === 'NotFoundError') msg += '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.';
                else if (error.name === 'NotReadableError') msg += '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.';
                else msg += error.message;
                alert(msg);
            }
        }

        async function createPeerConnection(targetUserId) {
            if (targetUserId === userId) {
                debug('–ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–æ–±–æ–π, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º');
                return null;
            }

            if (peerConnections.has(targetUserId)) {
                const existing = peerConnections.get(targetUserId);
                if (existing.connectionState === 'connected' || existing.connectionState === 'connecting') {
                    return existing;
                } else {
                    try { existing.close(); } catch (e) {}
                    peerConnections.delete(targetUserId);
                }
            }

            debug(`–°–æ–∑–¥–∞–Ω–∏–µ PeerConnection –¥–ª—è ${targetUserId}`);
            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ—Ç—Ä–µ–∫–∏
            if (localStream) {
                localStream.getAudioTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
            }

            // –û—Ç–ø—Ä–∞–≤–∫–∞ ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'candidate',
                        targetUserId: targetUserId,
                        candidate: event.candidate,
                        senderId: userId,
                        callSessionId: callSessionId,
                        version: CLIENT_VERSION
                    }));
                }
            };

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫–∞
            pc.ontrack = (event) => {
                debug(`–ü–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫ –æ—Ç ${targetUserId}`);
                let audio = document.getElementById(`audio-${targetUserId}`);
                if (!audio) {
                    audio = document.createElement('audio');
                    audio.id = `audio-${targetUserId}`;
                    audio.autoplay = true;
                    audio.controls = false; // —Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    document.body.appendChild(audio);
                }
                audio.srcObject = event.streams[0];
                addSystemMessage(`üîä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${targetUserId.substring(0,6)}... –≤ –∑–≤–æ–Ω–∫–µ`);
            };

            // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            pc.onconnectionstatechange = () => {
                debug(`–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ${targetUserId}: ${pc.connectionState}`);
                if (pc.connectionState === 'connected') {
                    callStatus.textContent = 'üîä –í –∑–≤–æ–Ω–∫–µ';
                    callStatus.className = 'call-active';
                } else if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
                    if (callActive && users.includes(targetUserId)) {
                        addSystemMessage(`‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ${targetUserId.substring(0,6)}...`);
                        // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                        setTimeout(() => {
                            if (callActive && users.includes(targetUserId) && shouldInitiateConnection(targetUserId)) {
                                peerConnections.delete(targetUserId);
                                createOffer(targetUserId);
                            }
                        }, 2000);
                    }
                }
            };

            peerConnections.set(targetUserId, pc);
            return pc;
        }

        async function createOffer(targetUserId) {
            try {
                if (!callActive || !localStream) return;
                if (!users.includes(targetUserId)) return;
                if (!shouldInitiateConnection(targetUserId)) return; // —Ç–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä

                const pc = await createPeerConnection(targetUserId);
                if (!pc) return;

                const offer = await pc.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: false
                });
                await pc.setLocalDescription(offer);

                ws.send(JSON.stringify({
                    type: 'offer',
                    targetUserId: targetUserId,
                    offer: offer,
                    senderId: userId,
                    callSessionId: callSessionId,
                    version: CLIENT_VERSION
                }));
                debug(`Offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ${targetUserId}`);
            } catch (error) {
                debug(`–û—à–∏–±–∫–∞ createOffer –¥–ª—è ${targetUserId}`, error.message);
            }
        }

        async function handleOffer(data) {
            try {
                if (!users.includes(data.senderId)) return;

                // –ï—Å–ª–∏ –∑–≤–æ–Ω–æ–∫ –µ—â—ë –Ω–µ –Ω–∞—á–∞—Ç, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
                if (!callActive) {
                    try {
                        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        callActive = true;
                        callSessionId = data.callSessionId; // –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Å—Å–∏—é –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞
                        startBtn.disabled = true;
                        endBtn.disabled = false;
                        callStatus.classList.remove('hidden');
                        callStatus.textContent = 'üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...';
                        callStatus.className = 'call-waiting';
                        addSystemMessage(`üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ${data.senderId.substring(0,6)}...`);
                    } catch (error) {
                        debug('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω –¥–ª—è –æ—Ç–≤–µ—Ç–∞', error.message);
                        return;
                    }
                }

                let pc = peerConnections.get(data.senderId);
                if (!pc) {
                    pc = await createPeerConnection(data.senderId);
                }

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ (glare) ‚Äì –µ—Å–ª–∏ —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π offer
                if (pc.signalingState === 'have-local-offer') {
                    // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º ID: –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –∏–º–µ–µ—Ç –º–µ–Ω—å—à–∏–π ID, –æ–Ω –ø—Ä–∞–≤, –º—ã –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è
                    if (data.senderId < userId) {
                        debug('–ö–æ–Ω—Ñ–ª–∏–∫—Ç: –ø—Ä–∏–Ω–∏–º–∞–µ–º offer –æ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–≥–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞, –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Å–≤–æ–π');
                        await pc.setLocalDescription({ type: 'rollback' });
                    } else {
                        debug('–ö–æ–Ω—Ñ–ª–∏–∫—Ç: –º—ã –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤—Ö–æ–¥—è—â–∏–π offer');
                        return;
                    }
                }

                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);

                ws.send(JSON.stringify({
                    type: 'answer',
                    targetUserId: data.senderId,
                    answer: answer,
                    senderId: userId,
                    callSessionId: callSessionId,
                    version: CLIENT_VERSION
                }));
                debug(`Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ${data.senderId}`);
            } catch (error) {
                debug('–û—à–∏–±–∫–∞ handleOffer', error.message);
            }
        }

        async function handleAnswer(data) {
            try {
                const pc = peerConnections.get(data.senderId);
                if (!pc) return;
                if (pc.signalingState !== 'have-local-offer') {
                    debug(`–ü–æ–ª—É—á–µ–Ω answer, –Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ 'have-local-offer' (${pc.signalingState}) ‚Äì –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º`);
                    return;
                }
                await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                debug(`Remote description —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è ${data.senderId}`);
            } catch (error) {
                debug('–û—à–∏–±–∫–∞ handleAnswer', error.message);
            }
        }

        async function handleCandidate(data) {
            try {
                const pc = peerConnections.get(data.senderId);
                if (!pc) {
                    debug(`–ü–æ–ª—É—á–µ–Ω –∫–∞–Ω–¥–∏–¥–∞—Ç, –Ω–æ PeerConnection –¥–ª—è ${data.senderId} –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω ‚Äì –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
                    return;
                }
                await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                debug(`ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è ${data.senderId}`);
            } catch (error) {
                debug('–û—à–∏–±–∫–∞ handleCandidate', error.message);
            }
        }

        function endCall() {
            debug('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞');
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ PeerConnection
            for (const [id, pc] of peerConnections) {
                try { pc.close(); } catch (e) {}
                const audio = document.getElementById(`audio-${id}`);
                if (audio) audio.remove();
            }
            peerConnections.clear();

            if (localStream) {
                localStream.getAudioTracks().forEach(track => track.stop());
                localStream = null;
            }

            callActive = false;
            callSessionId = null;

            startBtn.disabled = false;
            endBtn.disabled = true;
            callStatus.classList.add('hidden');
            callStatus.className = '';

            addSystemMessage('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω');
        }

        function resetUI() {
            endCall();
            loginForm.classList.remove('hidden');
            chatContainer.classList.add('hidden');
            usersList.classList.add('hidden');
            userId = null;
            users = [];
            debugInfo.textContent = '';
            debugInfo.classList.add('hidden');
        }

        // ================== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û ==================
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏)
        setInterval(() => {
            if (!callActive || !localStream) return;
            const others = users.filter(id => id !== userId);
            for (const target of others) {
                const pc = peerConnections.get(target);
                if (!pc || pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
                    if (shouldInitiateConnection(target)) {
                        if (pc) {
                            try { pc.close(); } catch (e) {}
                            peerConnections.delete(target);
                        }
                        createOffer(target);
                    }
                }
            }
        }, 5000);
    </script>
</body>
</html>